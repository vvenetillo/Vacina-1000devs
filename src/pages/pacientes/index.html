<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://unpkg.com/imask"></script>
    <title>Cadastro de Pacientes</title>
  </head>

  <body>
    <section id="cadastroPacientes" class="container mt-4">
      <h2 class="text-center text-primary mb-4">Cadastro de Pacientes</h2>
      <form id="formPaciente" class="p-4 shadow rounded bg-light">
        <div class="mb-3">
          <label for="nome" class="form-label">Nome</label>
          <input type="text" class="form-control" id="nome" required />
        </div>
        <div class="mb-3">
          <label for="cpf" class="form-label">CPF</label>
          <input type="text" class="form-control" id="cpf" required />
          <div class="text-danger mt-1" id="cpfError" style="display: none">
            CPF incompleto!
          </div>
        </div>
        <div class="mb-3">
          <label for="sexo" class="form-label">Sexo</label>
          <select class="form-select" id="sexo" required>
            <option value="">Selecione</option>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="dataNascimento" class="form-label"
            >Data de Nascimento</label
          >
          <input
            type="date"
            class="form-control"
            id="data_nascimento"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
      </form>
    </section>

    <script>
      var cpfElement = document.getElementById("cpf");
      var maskOptions = { mask: "000.000.000-00" };
      var maskCPF = IMask(cpfElement, maskOptions);
      document
        .getElementById("formPaciente")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const cpfElement = document.getElementById("cpf");
          const cpfValue = cpfElement.value.replace(/\D/g, ""); 
          const cpfError = document.getElementById("cpfError");

          if (cpfValue.length !== 11) {
            cpfError.style.display = "block";
            return;
          } else {
            cpfError.style.display = "none";
          }

          const dataNascimentoInput =
            document.getElementById("data_nascimento").value;
          const dataNascimentoFormatada = new Date(dataNascimentoInput)
            .toISOString()
            .split("T")[0];

          const paciente = {
            nome: document.getElementById("nome").value,
            cpf: cpfValue, 
            sexo: document.getElementById("sexo").value,
            data_nascimento: dataNascimentoFormatada, 
          };
          console.log(paciente); // Para teste, remova esse console.log() antes de submeter o formul√°rio.

          try {
            const response = await fetch(
              "http://localhost:8080/paciente/inserir",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(paciente),
              }
            );

            if (!response.ok) {
              throw new Error(
                "Erro ao cadastrar paciente. Verifique os dados e tente novamente."
              );
            }

            alert("Paciente cadastrado com sucesso!");
            window.location.href = "../listar-pacientes/index.html";
          } catch (error) {
            alert(error.message);
          }
        });
    </script>
  </body>
</html>
