<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Imunizações</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      width: 100vw;
      margin: 0;
      padding: 20px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    h1 {
      color: #2c3e50;
      font-size: 2rem;
      align-items: center;
      width: 0 auto;
    }

    #imuni {
      width: 50%;
    }

    form {
      width: 60%;
      max-width: 700px;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      justify-content: center;
      align-items: center;
    }

    label {
      font-weight: bold;
      color: #34495e;
      font-size: 14px;
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      background: #f9f9f9;
      transition: 0.3s;
    }

    input:focus,
    select:focus {
      border-color: #3498db;
      outline: none;
      background: white;
    }

    button {
      background-color: #3498db;
      color: white;
      font-size: 16px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      padding: 12px;
      transition: 0.3s;
      grid-column: span 2;
    }

    button:hover {
      background-color: #2980b9;
    }

    /* Responsivo */
    @media (max-width: 768px) {
      form {
        width: 90%;
        grid-template-columns: 1fr;
      }

      button {
        grid-column: span 1;
      }
    }
  </style>
</head>

<body>

  <div>
    <h1>Registro de Imunizações</h1>
    <img src="./img/imuni.png" alt="imunização" id="imuni">
  </div>
  <form id="form-imunizacao">
    <label for="id_paciente">Paciente</label>
    <select id="id_paciente"></select>

    <label for="id_vacina">Vacina</label>
    <select id="id_vacina"></select>

    <label for="id_dose">Dose</label>
    <select id="id_dose"></select>

    <label for="data_aplicacao">Data de Aplicação</label>
    <input type="date" id="data_aplicacao" required />

    <label for="fabricante">Fabricante</label>
    <input type="text" id="fabricante" required />

    <label for="lote">Lote</label>
    <input type="text" id="lote" required />

    <label for="local_aplicacao">Local de Aplicação</label>
    <input type="text" id="local_aplicacao" required />

    <label for="profissional_aplicador">Profissional Aplicador</label>
    <input type="text" id="profissional_aplicador" required />

    <button type="submit">Registrar Imunização</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      carregarPacientes();
      carregarVacinas();

      // Event listener para enviar o formulário de imunização
      document
        .getElementById("form-imunizacao")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          registrarImunizacao();
        });

      // Atualiza vacinas quando paciente mudar
      document
        .getElementById("id_paciente")
        .addEventListener("change", carregarVacinas);

      // Atualiza doses quando vacina mudar
      document
        .getElementById("id_vacina")
        .addEventListener("change", carregarDosesPorVacina);
    });

    // Função para carregar os pacientes
    function carregarPacientes() {
      fetch("http://localhost:8080/paciente/consultar")
        .then((response) => response.json())
        .then((pacientes) => {
          const selectPaciente = document.getElementById("id_paciente");
          pacientes.forEach((paciente) => {
            const option = document.createElement("option");
            option.value = paciente.id;
            option.textContent = paciente.nome;
            selectPaciente.appendChild(option);
          });
        })
        .catch((error) =>
          console.error("Erro ao carregar pacientes:", error)
        );
    }

    // Função para carregar as vacinas
    function carregarVacinas() {
      fetch("http://localhost:8080/vacinas/consultar")
        .then((response) => response.json())
        .then((vacinas) => {
          const selectVacina = document.getElementById("id_vacina");
          selectVacina.innerHTML = ""; // Limpa vacinas anteriores

          vacinas.forEach((vacina) => {
            const option = document.createElement("option");
            option.value = vacina.id;
            option.textContent = vacina.vacina;
            selectVacina.appendChild(option);
          });

          // Carregar doses quando vacinas são carregadas
          carregarDosesPorVacina();
        })
        .catch((error) => console.error("Erro ao carregar vacinas:", error));
    }

    // Função para carregar as doses com base na vacina selecionada
    function carregarDosesPorVacina() {
      const vacinaId = document.getElementById("id_vacina").value;
      if (!vacinaId) return; // Se não houver vacina selecionada, não faça nada

      fetch(`http://localhost:8080/dose/consultar/vacina/${vacinaId}`)
        .then((response) => response.json())
        .then((doses) => {
          const selectDose = document.getElementById("id_dose");
          selectDose.innerHTML = ""; // Limpa doses anteriores

          doses.forEach((dose) => {
            const option = document.createElement("option");
            option.value = dose.id;
            option.textContent = dose.dose;
            selectDose.appendChild(option);
          });
        })
        .catch((error) => console.error("Erro ao carregar doses:", error));
    }

    // Função para registrar uma nova imunização
    function registrarImunizacao() {
      const id_paciente = document.getElementById("id_paciente").value;
      const id_vacina = document.getElementById("id_vacina").value;
      const id_dose = document.getElementById("id_dose").value;
      const data_aplicacao = document.getElementById("data_aplicacao").value;
      const fabricante = document.getElementById("fabricante").value;
      const lote = document.getElementById("lote").value;
      const local_aplicacao =
        document.getElementById("local_aplicacao").value;
      const profissional_aplicador = document.getElementById(
        "profissional_aplicador"
      ).value;

      const imunizacao = {
        id_paciente: parseInt(id_paciente),
        id_vacina: parseInt(id_vacina),
        id_dose: parseInt(id_dose),
        data_aplicacao: formatarData(data_aplicacao),
        fabricante,
        lote,
        local_aplicacao,
        profissional_aplicador,
      };

      fetch("http://localhost:8080/imunizacao/inserir", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(imunizacao),
      })
        .then((response) => response.json())
        .then((data) => {
          alert(data.message);
          // Aguarda 1 segundo antes de redirecionar
          setTimeout(() => {
            window.location.href = "index2.html";
          }, 1000);
        })
        .catch((error) =>
          console.error("Erro ao cadastrar imunização:", error)
        );
    }
    document.addEventListener("DOMContentLoaded", () => {
      const localAplicacaoInput = document.getElementById("local_aplicacao");
      const suggestionsContainer = document.createElement("div");
      suggestionsContainer.setAttribute("id", "suggestions");
      suggestionsContainer.style.position = "absolute";
      suggestionsContainer.style.backgroundColor = "white";
      suggestionsContainer.style.border = "1px solid #ccc";
      suggestionsContainer.style.zIndex = "1000";
      localAplicacaoInput.parentNode.appendChild(suggestionsContainer);

      let distritos = [];

      // Buscar dados da API do IBGE
      fetch("https://servicodados.ibge.gov.br/api/v1/localidades/distritos")
        .then(response => response.json())
        .then(data => {
          distritos = data.map(distrito => ({
            nome: distrito.nome,
            estado: distrito.municipio.microrregiao.mesorregiao.UF.sigla
          }));
        })
        .catch(error => console.error("Erro ao buscar distritos:", error));

      localAplicacaoInput.addEventListener("input", () => {
        const query = localAplicacaoInput.value.toLowerCase();
        suggestionsContainer.innerHTML = "";
        const rect = localAplicacaoInput.getBoundingClientRect();
        suggestionsContainer.style.left = `${rect.left}px`;
        suggestionsContainer.style.top = `${rect.bottom}px`;
        suggestionsContainer.style.width = `${rect.width}px`;

        if (query.length < 2) return;

        const filtrados = distritos.filter(distrito =>
          distrito.nome.toLowerCase().includes(query)
        );

        filtrados.forEach(distrito => {
          const suggestionItem = document.createElement("div");
          suggestionItem.textContent = `${distrito.nome} - ${distrito.estado}`;
          suggestionItem.classList.add("suggestion-item");
          suggestionItem.style.padding = "5px";
          suggestionItem.style.cursor = "pointer";
          suggestionItem.addEventListener("click", () => {
            localAplicacaoInput.value = `${distrito.nome} - ${distrito.estado}`;
            suggestionsContainer.innerHTML = "";
          });
          suggestionsContainer.appendChild(suggestionItem);
        });
      });
    });


    // Função para formatar a data no padrão yyyy-MM-dd
    function formatarData(data) {
      const date = new Date(data);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0"); // Mês é zero-based
      const day = String(date.getDate()).padStart(2, "0");

      return `${year}-${month}-${day}`;
    }
  </script>
</body>

</html>